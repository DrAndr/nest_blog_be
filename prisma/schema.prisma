// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "./__generated__" //"../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id       String   @id @default(uuid())
  email    String   @unique
  password String
  name     String
  image    String?
  posts    Post[]
  role     UserRole @default(REGULAR)

  isVerified         Boolean @default(false) @map("is_verified")
  isTwoFactorEnabled Boolean @default(false) @map("is_two_factor_enabled")

  banned Boolean @default(false)

  method   AuthMethod
  accounts Account[]
  files    Files[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Account {
  id String @id @default(uuid())

  type     String
  provider String

  refreshToken String? @map("refresh_token")
  accessToken  String  @map("access_token")
  expiresAt    Int     @map("expires_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("account")
}

model Token {
  id String @id @default(uuid())

  email     String
  token     String    @unique
  type      TokenType
  expiresIn DateTime  @map("expires_in")
  createdAt DateTime  @default(now()) @map("created_at")

  @@map("tokens")
}

model Post {
  id          String   @id @default(uuid())
  title       String
  content     String?
  published   Boolean  @default(false)
  author      User     @relation(fields: [authorId], references: [id])
  authorId    String
  publishedAt DateTime @default(now()) @map("published_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("posts")
}

model Folders {
  id   String @id @default(uuid())
  name String

  // it`s not useful when user change parrent folder, as it`s forsed us to update path for all childrens
  // path String @unique 

  parentId String?
  parent   Folders?  @relation("Tree", fields: [parentId], references: [id])
  children Folders[] @relation("Tree")

  files Files[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("folders")
}

// TODO: implement access control for folders (e.g., read, write, admin)
// model FolderAccess {
//   id String @id @default(uuid())

//   folderId String
//   userId   String
//   role     String
// }

model Files {
  id           String @id @default(uuid())
  originalname String @default("")
  extension    String @default("")
  mimeType     String
  size         Int

  checksum      String? // for prevent duplication
  blurhash      String? // for preview
  dominantColor String? // for filteryng by main color

  storageKey    String @unique @map("origin_file") // path to original image

  // TODO: implement background processing for files (e.g., generating variants, extracting metadata)
  // processingStatus FileProcessingStatus @default(PENDING)

  folderId String?
  folder   Folders? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  isPrivate Boolean @default(true)

  variants FileVariants[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("files")
}

model FileVariants {
  id String @id @default(uuid())

  fileId String
  file   Files  @relation(fields: [fileId], references: [id], onDelete: Cascade)

  type       VariantType
  storageKey String      @unique // path to variant

  format String // webp, jpg, png
  width  Int?
  height Int?
  size   Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("file_variants")
}

// TODO: implement background processing for files (e.g., generating variants, extracting metadata)
// enum FileProcessingStatus {
//   PENDING
//   PROCESSING
//   DONE
//   FAILED
// }

enum VariantType {
  ORIGINAL
  THUMBNAIL
  SMALL
  MEDIUM
  LARGE
  CUSTOM
}

enum UserRole {
  ADMIN
  MANAGER
  REGULAR
}

enum AuthMethod {
  CREDENTIALS
  GOOGLE
  YANDEX
}

enum TokenType {
  VERIFICATION
  PASSWORD_RESET
  TWO_FACTOR
}
